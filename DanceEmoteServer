-- ============================================================
-- DANCE & EMOTE GUI - SERVER SCRIPT
-- Author: ItoRenz00
-- Version: 4.0 - SERVER DATASTORE SYSTEM
-- Description:
-- Handles persistent favorites DataStore for Dance & Emote GUI
-- Place this script in ServerScriptService
-- ============================================================

local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- DataStore for saving favorites
local FavoritesDataStore = DataStoreService:GetDataStore("DanceEmoteFavorites_v1")

-- Remote Events and Functions for Client-Server communication
local RemoteFolder = Instance.new("Folder")
RemoteFolder.Name = "DanceEmoteRemotes"
RemoteFolder.Parent = ReplicatedStorage

local SaveFavoritesEvent = Instance.new("RemoteEvent")
SaveFavoritesEvent.Name = "SaveFavorites"
SaveFavoritesEvent.Parent = RemoteFolder

local LoadFavoritesEvent = Instance.new("RemoteFunction")
LoadFavoritesEvent.Name = "LoadFavorites"
LoadFavoritesEvent.Parent = RemoteFolder

-- Cache to reduce DataStore calls
local playerFavoritesCache = {}

-- Load favorites for a player
local function loadPlayerFavorites(player)
    local userId = player.UserId
    local success, data = pcall(function()
        return FavoritesDataStore:GetAsync("Player_" .. userId)
    end)

    if success and data then
        playerFavoritesCache[userId] = data
        return data
    else
        playerFavoritesCache[userId] = {}
        return {}
    end
end

-- Save favorites for a player asynchronously
local function savePlayerFavorites(player, favoritesData)
    local userId = player.UserId
    playerFavoritesCache[userId] = favoritesData

    -- Async saving with pcall and no repeated log if success
    task.spawn(function()
        local success, err = pcall(function()
            FavoritesDataStore:SetAsync("Player_" .. userId, favoritesData)
        end)

        if not success then
            warn("[Dance GUI] Failed to save favorites for " .. player.Name .. ": " .. tostring(err))
        end
    end)
end

-- RemoteFunction to handle load requests
LoadFavoritesEvent.OnServerInvoke = function(player)
    return loadPlayerFavorites(player)
end

-- RemoteEvent to handle save requests
SaveFavoritesEvent.OnServerEvent:Connect(function(player, favoritesData)
    if type(favoritesData) == "table" then
        savePlayerFavorites(player, favoritesData)
    end
end)

-- Preload favorites cache when player joins
Players.PlayerAdded:Connect(function(player)
    loadPlayerFavorites(player)
end)

-- Save favorites cache on player leaving with one final save to DataStore
Players.PlayerRemoving:Connect(function(player)
    local userId = player.UserId
    local cachedData = playerFavoritesCache[userId]

    if cachedData then
        local success, err = pcall(function()
            FavoritesDataStore:SetAsync("Player_" .. userId, cachedData)
        end)

        if success then
            print("[Dance GUI] Saved favorites for " .. player.Name)
        else
            warn("[Dance GUI] Failed final save for " .. player.Name .. ": " .. tostring(err))
        end

        playerFavoritesCache[userId] = nil
    end
end)

print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("ğŸ‘¤ Author: ItoRenz00")
print("âœ… Dance & Emote Server Script Active")
print("ğŸ’¾ DataStore System Ready")
print("ğŸ“¦ Version: 4.0 - SERVER DATASTORE SYSTEM")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
